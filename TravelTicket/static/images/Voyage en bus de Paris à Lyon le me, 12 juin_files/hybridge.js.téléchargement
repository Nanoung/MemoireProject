"use strict";(()=>{var l={"hybrid.event":e=>{r.sendStructuredEvent(e)},"search.results.app_painted":()=>{r.sendStructuredEvent({category:"hybridFlow",action:"search.results.app_painted"})},"checkout.submit":()=>{r.sendStructuredEvent({category:"Checkout",action:"checkout.submit_valid"})},"checkout.submit_invalid":()=>{r.sendStructuredEvent({category:"Checkout",action:"checkout.submit_invalid"})},"checkout.seat_not_selected":()=>{r.sendStructuredEvent({category:"Checkout",action:"checkout.seat_not_selected"})},"payments.payment.processing_failed":e=>{var t;r.sendStructuredEvent({category:"Payments",action:"Payment Error",label:(t=e.errorCode)!=null?t:void 0,property:typeof e.featureFlags=="object"?JSON.stringify(e.featureFlags):void 0})},"waiting.payment.redirect":e=>{var n,i;if(((n=e.result)==null?void 0:n.status)!=="redirect")return;let t=(i=e.result)!=null&&i.orderId?e.result.orderId.toString():void 0;r.sendStructuredEvent({category:"Waiting",action:"waiting.payment.redirect",label:t})},"search.results.results_visible":e=>{if(r.searchInfo=e.searchInfo,r.currency=e.searchInfo.currency,r.stations=e.searchInfo.stations,r.trips=e.results,!e.results.length)return;let t=[];e.results.forEach(n=>{t.push({id:n.uid,name:`${r.stations[n.departure.stationId].slug}#${r.stations[n.arrival.stationId].slug}`,price:parseFloat(n.price.total.toFixed(2))})}),r.sendEcomEvent({action:"impressions",currency:r.currency,products:t}),r.sendAdjustEvent({action:"view_content",parameters:o(r.searchInfo,e.results[0])})},"search.results.trip_selected":e=>{if(!r.searchInfo||!r.currency)return;let t=r.trips.find(n=>n.uid===e.tripUid);t&&(r.sendEcomEvent({action:"add",currency:r.currency,products:[{id:t.uid,name:`${r.stations[t.departure.stationId].slug}#${r.stations[t.arrival.stationId].slug}`,price:parseFloat(t.price.total.toFixed(2))}],total:0}),r.sendAdjustEvent({action:"add_to_cart",parameters:o(r.searchInfo,t)}))},"search.results.trip_removed_from_cart":e=>{if(!r.currency)return;let t=r.trips.find(n=>n.uid===e.tripUid);t&&r.sendEcomEvent({action:"remove",currency:r.currency,products:[{id:t.uid,name:`${r.stations[t.departure.stationId].slug}#${r.stations[t.arrival.stationId].slug}`,price:parseFloat(t.price.total.toFixed(2))}],total:0})},"search.results.trip_details_opened":e=>{if(!r.currency)return;let t=r.trips.find(n=>n.uid===e.id);t&&r.sendEcomEvent({action:"view",currency:r.currency,product:{id:t.uid,name:`${r.stations[t.departure.stationId].slug}#${r.stations[t.arrival.stationId].slug}`,price:parseFloat(t.price.total.toFixed(2))}})},"checkout.init":e=>{if(!r.searchInfo)return;let t=e.payload.cart.items.find(i=>i.product.type==="ticket");if(!t)return;let n=r.trips.find(i=>{var a;return i.uid===((a=t.product.trip)==null?void 0:a.id)});n&&r.sendAdjustEvent({action:"initiate_checkout",parameters:o(r.searchInfo,n)})},"checkout.ancillaries.impression":e=>{if(!e.data.length)return;let t=[];e.data.forEach(n=>{t.push({id:n.id,name:n.type,price:parseFloat(n.price.toFixed(2))})}),r.sendEcomEvent({action:"impressions",currency:e.data[0].currency,products:t})},"checkout.ancillaries.details":e=>{e.data.length&&e.data.forEach(t=>{r.sendEcomEvent({action:"view",currency:e.data[0].currency,product:{id:t.id,name:t.type,price:parseFloat(t.price.toFixed(2))}})})},"checkout.ancillaries.add":e=>{if(!e.data.length)return;let t=[];e.data.forEach(n=>{t.push({id:n.id,name:n.type,price:parseFloat(n.price.toFixed(2))})}),r.sendEcomEvent({action:"add",currency:e.data[0].currency,products:t,total:0})},"checkout.ancillaries.remove":e=>{if(!e.data.length)return;let t=[];e.data.forEach(n=>{t.push({id:n.id,name:n.type,price:parseFloat(n.price.toFixed(2))})}),r.sendEcomEvent({action:"remove",currency:e.data[0].currency,products:t,total:0})},flixperiments:e=>{Object.entries(e).forEach(([t,n])=>{r.sendAbEvent({name:t.toString(),variation:n.toString(),source:"fxp"})})},"robotnik.ab_test_flags":e=>{Object.entries(e).forEach(([t,n])=>{r.sendAbEvent({name:t.toString(),variation:n.toString(),source:"cat"})})},"anthill.seatmap.load":()=>{r.sendStructuredEvent({category:"Anthill",action:"anthill.seatmap.load"})},"anthill.seatmap.click":()=>{r.sendStructuredEvent({category:"Anthill",action:"anthill.seatmap.click"})}},s=l,o=(e,t)=>{var n,i;return{fb_content_id:JSON.stringify([[e.fromCity.legacyId,e.toCity.legacyId].join("#"),e.toCity.legacyId.toString()]),fb_content_type:'["hotel", "destination"]',fb_travel_start:c(e.departureDate),fb_travel_end:e.returnDate?c(e.returnDate):null,fb_checkin_date:c(e.departureDate),fb_checkout_date:e.returnDate?c(e.returnDate):null,fb_city:e.toCity.name,fb_region:e.toCity.name,fb_country:e.toCity.countryCode,fb_num_adults:(((n=e.products.adult)!=null?n:0)+((i=e.products.children)!=null?i:0)).toString(),fb_currency:e.currency,_valueToSum:t.price.total.toFixed(2)}},c=(e,t="dd-MM-yyyy")=>{let n=new Date(e),i=n.getDate(),a=n.getMonth()+1,d=n.getFullYear();return t=t.replace("MM",a.toString().padStart(2,"0")),t.indexOf("yyyy")>-1?t=t.replace("yyyy",d.toString()):t.indexOf("yy")>-1&&(t=t.replace("yy",d.toString().substr(2,2))),t=t.replace("dd",i.toString().padStart(2,"0")),t};var u={port:void 0,debug:!1,cache:[],currency:void 0,stations:{},trips:[],searchInfo:void 0,init(e){var n;let t=((n=window.webkit)==null?void 0:n.messageHandlers.eventListener)||(e==null?void 0:e.ports[0])||void 0;this.debug&&console.log("[hybridge event] port",{port:t}),t&&u.setPort(t)},setDebug(e){this.debug=e,window.hybridEventsCache=this.debug?this.cache:void 0},setPort(e){this.port=e,this.sendCachedEvents()},sendEvent(e){this.port?this.port.postMessage(JSON.stringify(e)):this.cache.push(e),this.debug&&console.log("[hybridge event] sent",{event:e,port:this.port})},sendPageviewEvent(e){this.sendEvent({name:"pageview",payloads:{url:e}})},sendStructuredEvent(e){this.sendEvent({name:"event",payloads:e})},sendEcomEvent(e){this.sendEvent({name:"ecom",payloads:e})},sendAbEvent(e){this.sendEvent({name:"abtest",payloads:e})},sendAdjustEvent(e){this.sendEvent({name:"adjust",payloads:e})},sendCachedEvents(){this.cache.length&&this.port&&this.cache.forEach(e=>this.sendEvent(e))},attachPageviewEvent(){(t=>{let n;setInterval(()=>{let i=t.location.pathname;i=i.indexOf("/waiting")===0?"/waiting":i,i!==n&&(this.sendPageviewEvent(i),n=i)},100)})(window)},attachGlobalEvents(){window.globalEvents.onAny((e,t)=>this.globalEventsHandler(e,t))},handleCachedGlobalEvents(){if(!window.globalEventsCache||!window.globalEventsCache.length)return!1;window.globalEventsCache.forEach(e=>this.globalEventsHandler(e.name,e.payload[0]))},globalEventsHandler(e,t){try{switch(e){case"hybrid.event":s[e](t);break;case"search.results.app_painted":case"checkout.submit":case"checkout.submit_invalid":case"checkout.seat_not_selected":s[e]();break;case"payments.payment.processing_failed":s[e](t);break;case"waiting.payment.redirect":s[e](t);break;case"search.results.results_visible":s[e](t);break;case"search.results.trip_selected":s[e](t);break;case"search.results.trip_removed_from_cart":s[e](t);break;case"search.results.trip_details_opened":s[e](t);break;case"checkout.init":s[e](t);break;case"checkout.ancillaries.impression":case"checkout.ancillaries.details":case"checkout.ancillaries.add":case"checkout.ancillaries.remove":s[e](t);break;case"flixperiments":case"robotnik.ab_test_flags":s[e](t);break;case"anthill.seatmap.load":case"anthill.seatmap.click":s[e]();break;default:break}}catch(n){console.error(n)}}},r=u;var h=document.cookie.indexOf("hybridge_debug=1")>-1;r.setDebug(h);r.init();window.addEventListener("message",e=>r.init(e));r.attachPageviewEvent();var p=()=>{typeof window.globalEvents=="object"&&(clearInterval(v),r.attachGlobalEvents(),r.handleCachedGlobalEvents())},v=setInterval(p,200);})();
